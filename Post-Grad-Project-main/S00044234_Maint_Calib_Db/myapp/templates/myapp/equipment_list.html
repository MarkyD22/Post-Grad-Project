{% extends 'myapp/base_dashboard.html' %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h2 style="color: #1e3c72; margin-bottom: 1rem;">Equipment Management</h2>
    
    <!-- Search and Filter Section -->
    <div class="dashboard-card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <div class="card-icon">üîç</div>
            <h3 class="card-title">Search & Filter Equipment</h3>
        </div>
        <div class="card-content">
            <form method="GET" style="display: grid; grid-template-columns: 1fr 200px 150px; gap: 1rem; align-items: end;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1e3c72;">Search Equipment</label>
                    <input type="text" name="search" value="{{ search_query }}" 
                           placeholder="Search by ID, name, or location..." 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1e3c72;">Filter by Status</label>
                    <select name="status" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">All Equipment</option>
                        <option value="overdue_maintenance" {% if status_filter == 'overdue_maintenance' %}selected{% endif %}>Overdue Maintenance</option>
                        <option value="overdue_calibration" {% if status_filter == 'overdue_calibration' %}selected{% endif %}>Overdue Calibration</option>
                        <option value="due_soon" {% if status_filter == 'due_soon' %}selected{% endif %}>Due Soon</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Search</button>
            </form>
            
            {% if search_query or status_filter %}
                <div style="margin-top: 1rem;">
                    <a href="{% url 'equipment_list' %}" class="btn btn-outline" style="padding: 0.3rem 0.8rem; font-size: 0.9rem;">Clear Filters</a>
                    <span style="margin-left: 1rem; color: #666;">Found {{ total_count }} equipment items</span>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Equipment List -->
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon">‚öôÔ∏è</div>
            <h3 class="card-title">Equipment List ({{ total_count }} items)</h3>
            {% if user.profile.role == 'administrator' %}
                <a href="{% url 'add_equipment' %}" class="btn btn-secondary" style="margin-left: auto;">Add New Equipment</a>
            {% endif %}
        </div>
        <div class="card-content">
            {% if equipment_list %}
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #ddd;">
                                <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">Equipment ID</th>
                                <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">Name</th>
                                <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">Type</th>
                                <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">Location</th>
                                <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #ddd;">Maintenance Status</th>
                                <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #ddd;">Calibration Status</th>
                                <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #ddd;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for equipment in equipment_list %}
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 1rem; border-bottom: 1px solid #eee;">
                                    <strong>{{ equipment.Machine_ID }}</strong>
                                </td>
                                <td style="padding: 1rem; border-bottom: 1px solid #eee;">
                                    <a href="{% url 'equipment_detail' equipment.Machine_ID %}" 
                                       style="color: #1e3c72; text-decoration: none; font-weight: 600;">
                                        {{ equipment.Machine_Name }}
                                    </a>
                                </td>
                                <td style="padding: 1rem; border-bottom: 1px solid #eee;">
                                    {{ equipment.get_Machine_Type_display }}
                                </td>
                                <td style="padding: 1rem; border-bottom: 1px solid #eee;">
                                    {{ equipment.Machine_Location }}
                                </td>
                                <td style="padding: 1rem; text-align: center; border-bottom: 1px solid #eee;">
                                    {% if equipment.maintenance_status == 'overdue' %}
                                        <span style="background: #dc3545; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">Overdue</span>
                                    {% elif equipment.maintenance_status == 'due_soon' %}
                                        <span style="background: #ffc107; color: #856404; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">Due Soon</span>
                                    {% elif equipment.maintenance_status == 'ok' %}
                                        <span style="background: #28a745; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">OK</span>
                                    {% else %}
                                        <span style="background: #6c757d; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">No Data</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 1rem; text-align: center; border-bottom: 1px solid #eee;">
                                    {% if equipment.calibration_status == 'overdue' %}
                                        <span style="background: #dc3545; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">Overdue</span>
                                    {% elif equipment.calibration_status == 'due_soon' %}
                                        <span style="background: #ffc107; color: #856404; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">Due Soon</span>
                                    {% elif equipment.calibration_status == 'ok' %}
                                        <span style="background: #28a745; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">OK</span>
                                    {% else %}
                                        <span style="background: #6c757d; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">No Data</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 1rem; text-align: center; border-bottom: 1px solid #eee;">
                                    <a href="{% url 'equipment_detail' equipment.Machine_ID %}" 
                                       class="btn btn-outline" style="padding: 0.3rem 0.8rem; font-size: 0.8rem; margin-right: 0.5rem;">
                                        View Details
                                    </a>
                                    {% if equipment.maintenance_status == 'overdue' or equipment.calibration_status == 'overdue' %}
                                        <button onclick="showQuickComplete('{{ equipment.Machine_ID }}', '{{ equipment.Machine_Name }}')" 
                                                class="btn btn-secondary" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                                            Quick Complete
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if equipment_list.has_other_pages %}
                    <div style="display: flex; justify-content: center; margin-top: 2rem; gap: 0.5rem;">
                        {% if equipment_list.has_previous %}
                            <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" 
                               class="btn btn-outline">First</a>
                            <a href="?page={{ equipment_list.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" 
                               class="btn btn-outline">Previous</a>
                        {% endif %}

                        <span style="padding: 0.6rem 1.2rem; background: #1e3c72; color: white; border-radius: 8px;">
                            Page {{ equipment_list.number }} of {{ equipment_list.paginator.num_pages }}
                        </span>

                        {% if equipment_list.has_next %}
                            <a href="?page={{ equipment_list.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" 
                               class="btn btn-outline">Next</a>
                            <a href="?page={{ equipment_list.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" 
                               class="btn btn-outline">Last</a>
                        {% endif %}
                    </div>
                {% endif %}
            {% else %}
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                    <h3 style="color: #666; margin-bottom: 1rem;">No Equipment Found</h3>
                    <p style="color: #666; margin-bottom: 2rem;">
                        {% if search_query %}
                            No equipment matches your search "{{ search_query }}".
                        {% else %}
                            No equipment has been added to the system yet.
                        {% endif %}
                    </p>
                    {% if user.profile.role == 'administrator' %}
                        <a href="{% url 'add_equipment' %}" class="btn btn-primary">Add First Equipment</a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Quick Complete Modal -->
<div id="quickCompleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 15px; max-width: 400px; width: 90%;">
        <h3 style="color: #1e3c72; margin-bottom: 1rem;">Complete Task</h3>
        <p>Mark task as complete for: <strong id="equipmentName"></strong></p>
        
        <form method="post" action="{% url 'mark_task_complete' %}">
            {% csrf_token %}
            <input type="hidden" id="machineId" name="machine_id" value="">
            
            <div style="margin: 1rem 0;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Task Type:</label>
                <select name="task_type" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="maintenance">Maintenance</option>
                    <option value="calibration">Calibration</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary">Complete Task</button>
                <button type="button" onclick="hideQuickComplete()" class="btn btn-outline">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
function showQuickComplete(machineId, equipmentName) {
    document.getElementById('machineId').value = machineId;
    document.getElementById('equipmentName').textContent = equipmentName;
    document.getElementById('quickCompleteModal').style.display = 'block';
}

function hideQuickComplete() {
    document.getElementById('quickCompleteModal').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('quickCompleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideQuickComplete();
    }
});
</script>
{% endblock %}